# Configuration
$zapDir = "C:\Users\msp_rmccurdy\Downloads\openjdk-24_windows-x64_bin\jdk-24\bin\ZAP_2.17.0"
$javaPath = "C:\Users\msp_rmccurdy\Downloads\openjdk-24_windows-x64_bin\jdk-24\bin\java.exe"
$zapJar = Join-Path $zapDir "zap-2.17.0.jar"
$zapApiUrl = "http://localhost:8080"
$reportPath = "C:\ZAP-Reports"

# Target URLs
$targets = @(
    "http://xxxxxxxxxxxxxx:5985", "http://xxxxxxxxxx7:80"

# Create report directory
New-Item -ItemType Directory -Force -Path $reportPath | Out-Null

# Start ZAP in daemon mode
Write-Host "Starting ZAP daemon..." -ForegroundColor Cyan
$zapArgs = @(
    "-Xmx2g",
    "-jar", $zapJar,
    "-daemon",
    "-config", "api.disablekey=true",
    "-port", "8080"
)
$zapProcess = Start-Process -FilePath $javaPath -ArgumentList $zapArgs -PassThru -WindowStyle Hidden
Start-Sleep -Seconds 20

# Function to check ZAP status
function Test-ZapReady {
    try {
        $response = Invoke-RestMethod -Uri "$zapApiUrl/JSON/core/view/version/" -Method Get -ErrorAction Stop
        return $true
    } catch {
        return $false
    }
}

# Wait for ZAP to be ready
$maxWait = 90
$waited = 0
while (-not (Test-ZapReady) -and $waited -lt $maxWait) {
    Write-Host "Waiting for ZAP to start..." -ForegroundColor Yellow
    Start-Sleep -Seconds 5
    $waited += 5
}

if (-not (Test-ZapReady)) {
    Write-Host "ZAP failed to start" -ForegroundColor Red
    Stop-Process -Id $zapProcess.Id -Force -ErrorAction SilentlyContinue
    exit 1
}

Write-Host "ZAP is ready" -ForegroundColor Green

# Scan each target
foreach ($target in $targets) {
    $targetName = ($target -replace 'https?://', '' -replace '[:/]', '_')
    Write-Host "`nScanning: $target" -ForegroundColor Cyan

    try {
        # Spider the target
        Write-Host "  Starting spider..." -ForegroundColor Yellow
        $spiderResponse = Invoke-RestMethod -Uri "$zapApiUrl/JSON/spider/action/scan/?url=$([uri]::EscapeDataString($target))" -Method Get
        $spiderId = $spiderResponse.scan

        # Monitor spider progress
        do {
            Start-Sleep -Seconds 2
            $spiderStatus = Invoke-RestMethod -Uri "$zapApiUrl/JSON/spider/view/status/?scanId=$spiderId" -Method Get
            $progress = $spiderStatus.status
            Write-Host "  Spider progress: $progress%" -ForegroundColor Yellow
        } while ([int]$progress -lt 100)

        # Start active scan
        Write-Host "  Starting active scan..." -ForegroundColor Yellow
        $scanResponse = Invoke-RestMethod -Uri "$zapApiUrl/JSON/ascan/action/scan/?url=$([uri]::EscapeDataString($target))" -Method Get
        $scanId = $scanResponse.scan

        # Monitor scan progress
        do {
            Start-Sleep -Seconds 5
            $scanStatus = Invoke-RestMethod -Uri "$zapApiUrl/JSON/ascan/view/status/?scanId=$scanId" -Method Get
            $progress = $scanStatus.status
            Write-Host "  Active scan progress: $progress%" -ForegroundColor Yellow
        } while ([int]$progress -lt 100)

        # Generate HTML report
        $reportFile = Join-Path $reportPath "$targetName-report.html"
        $htmlReport = Invoke-RestMethod -Uri "$zapApiUrl/OTHER/core/other/htmlreport/" -Method Get
        $htmlReport | Out-File -FilePath $reportFile -Encoding UTF8

        Write-Host "  Report saved: $reportFile" -ForegroundColor Green
    }
    catch {
        Write-Host "  Error scanning ${target}: $_" -ForegroundColor Red
    }
}

# Get summary of all alerts
Write-Host "`nGenerating summary report..." -ForegroundColor Cyan
$alerts = Invoke-RestMethod -Uri "$zapApiUrl/JSON/core/view/alerts/" -Method Get
$summaryFile = Join-Path $reportPath "summary.json"
$alerts | ConvertTo-Json -Depth 10 | Out-File -FilePath $summaryFile -Encoding UTF8

Write-Host "`nAll scans completed!" -ForegroundColor Green
Write-Host "Reports saved to: $reportPath" -ForegroundColor Green

# Stop ZAP
Write-Host "`nStopping ZAP..." -ForegroundColor Cyan
try {
    Invoke-RestMethod -Uri "$zapApiUrl/JSON/core/action/shutdown/" -Method Get -ErrorAction SilentlyContinue | Out-Null
} catch {}
Start-Sleep -Seconds 3
Stop-Process -Id $zapProcess.Id -Force -ErrorAction SilentlyContinue

Write-Host "Done!" -ForegroundColor Green
