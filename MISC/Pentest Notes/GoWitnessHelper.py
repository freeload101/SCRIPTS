#!/usr/bin/env python3
import argparse
import csv
import os
import subprocess
import sys
import shutil
import imagehash
from pathlib import Path
from PIL import Image
from collections import defaultdict

def create_urls_csv(input_file):
    """Convert IP,PORT format to URLs with http:// and https:// prepended"""
    urls = []
    print(f"[DEBUG] Reading input file: {input_file}")
    with open(input_file, 'r') as f:
        for line in f:
            line = line.strip()
            if not line:
                continue
            # Replace comma with colon for proper URL format
            line = line.replace(',', ':')
            urls.append(f"https://{line}")
            urls.append(f"http://{line}")

    print(f"[DEBUG] Generated {len(urls)} URLs")
    with open('URLS.csv', 'w', newline='') as f:
        writer = csv.writer(f)
        for url in urls:
            writer.writerow([url])
    print(f"[+] Created URLS.csv with {len(urls)} entries")

    if os.path.exists('URLS.csv'):
        size = os.path.getsize('URLS.csv')
        print(f"[DEBUG] URLS.csv created successfully ({size} bytes)")
        with open('URLS.csv', 'r') as f:
            lines = f.readlines()[:5]
            print(f"[DEBUG] First few URLs: {[l.strip() for l in lines]}")
    else:
        print("[ERROR] Failed to create URLS.csv")
        sys.exit(1)

def check_and_install_go():
    """Check if Go is installed, install if missing"""
    try:
        result = subprocess.run(['go', 'version'], check=True, capture_output=True, text=True)
        print(f"[+] Go is already installed: {result.stdout.strip()}")
    except (subprocess.CalledProcessError, FileNotFoundError):
        print("[!] Go not found. Installing...")
        subprocess.run(['sudo', 'apt-get', 'update'], check=True)
        subprocess.run(['sudo', 'apt-get', 'install', '-y', 'golang-go'], check=True)
        print("[+] Go installed successfully")

def install_gowitness():
    """Install gowitness using go install"""
    print("[+] Installing gowitness...")
    result = subprocess.run(['go', 'install', 'github.com/sensepost/gowitness@latest'], 
                          capture_output=True, text=True)
    if result.returncode == 0:
        print("[+] gowitness installed successfully")
    else:
        print(f"[DEBUG] gowitness install output: {result.stdout}")
        print(f"[DEBUG] gowitness install errors: {result.stderr}")

def setup_python_env():
    """Setup Python environment and install imagehash"""
    try:
        import imagehash
        print("[+] imagehash already installed")
    except ImportError:
        print("[!] imagehash not found. Installing...")
        subprocess.run([sys.executable, '-m', 'pip', 'install', 'imagehash', 'Pillow'], check=True)
        print("[+] imagehash installed successfully")

def run_gowitness():
    """Execute gowitness with specified arguments"""
    gowitness_path = os.path.expanduser('~/go/bin/gowitness')
    screenshot_dir = './my-screenshots/'
    Path(screenshot_dir).mkdir(parents=True, exist_ok=True)

    print(f"[DEBUG] gowitness path: {gowitness_path}")
    print(f"[DEBUG] gowitness exists: {os.path.exists(gowitness_path)}")

    if not os.path.exists(gowitness_path):
        print("[ERROR] gowitness binary not found!")
        print(f"[DEBUG] Checking alternative locations...")
        alt_path = subprocess.run(['which', 'gowitness'], capture_output=True, text=True)
        if alt_path.returncode == 0:
            gowitness_path = alt_path.stdout.strip()
            print(f"[DEBUG] Found gowitness at: {gowitness_path}")
        else:
            print("[ERROR] gowitness not found in PATH either")
            sys.exit(1)

    version_result = subprocess.run([gowitness_path, 'version'], capture_output=True, text=True)
    print(f"[DEBUG] gowitness version: {version_result.stdout.strip()}")

    javascript_code = "() => { window.alert = () => {}; window.confirm = () => true; }"

    cmd = [
        gowitness_path, 'scan', 'file',
        '-f', 'URLS.csv',
        '--write-jsonl',
        '--write-db',
        '-T', '10',
        '-t', '21',
        '--screenshot-fullpage',
        '-s', screenshot_dir,
        '--chrome-path', '/usr/bin/chromium',
        '--chrome-window-x', '1280',
        '--chrome-window-y', '720',
        '--delay', '5',
        '--log-scan-errors',
        '--debug-log',
        '--javascript', javascript_code
    ]

    print(f"[DEBUG] Running command:")
    print(f"[DEBUG] {gowitness_path} scan file -f URLS.csv --write-jsonl --write-db -T 10 -t 21 --screenshot-fullpage -s {screenshot_dir} --chrome-path /usr/bin/chromium --chrome-window-x 1280 --chrome-window-y 720 --delay 5 --log-scan-errors --debug-log --javascript \"{javascript_code}\"")
    print("[+] Running gowitness...")
    print("[DEBUG] This may take a while depending on the number of URLs...")

    process = subprocess.Popen(cmd, stdout=subprocess.PIPE, stderr=subprocess.STDOUT, text=True, bufsize=1)
    for line in process.stdout:
        print(line, end='')

    process.wait()

    if process.returncode != 0:
        print(f"[ERROR] gowitness exited with code {process.returncode}")
        print("[DEBUG] Check the output above for specific errors")
        sys.exit(1)

    print("[+] gowitness scan complete")

    screenshots = list(Path(screenshot_dir).glob('*.png')) + list(Path(screenshot_dir).glob('*.jpg'))
    print(f"[DEBUG] Found {len(screenshots)} screenshots in {screenshot_dir}")
    if len(screenshots) == 0:
        print("[WARNING] No screenshots were created!")

def find_similar_images(directory, threshold=0):
    """Find and group similar images using perceptual hashing"""
    hashes = {}
    duplicates = defaultdict(list)

    print(f"[+] Scanning {directory} for images...")

    for filename in os.listdir(directory):
        filepath = os.path.join(directory, filename)

        if not os.path.isfile(filepath):
            continue

        try:
            with Image.open(filepath) as img:
                img_hash = imagehash.phash(img)
                hashes[filepath] = img_hash
        except Exception as e:
            print(f"[!] Error processing {filename}: {e}")

    print(f"[DEBUG] Successfully hashed {len(hashes)} images")

    processed = set()
    for path1, hash1 in hashes.items():
        if path1 in processed:
            continue

        similar_group = [path1]
        for path2, hash2 in hashes.items():
            if path1 != path2 and path2 not in processed:
                if hash1 - hash2 <= threshold:
                    similar_group.append(path2)
                    processed.add(path2)

        if len(similar_group) > 1:
            duplicates[path1] = similar_group
        processed.add(path1)

    return duplicates

def move_duplicates(duplicates, output_folder):
    """Move duplicate images to a separate folder, keeping one from each group"""
    if not os.path.exists(output_folder):
        os.makedirs(output_folder)
        print(f"[+] Created folder: {output_folder}")

    moved_count = 0

    for original, similar_images in duplicates.items():
        images_to_move = similar_images[1:]

        for img_path in images_to_move:
            try:
                filename = os.path.basename(img_path)
                dest_path = os.path.join(output_folder, filename)

                if os.path.exists(dest_path):
                    base, ext = os.path.splitext(filename)
                    counter = 1
                    while os.path.exists(dest_path):
                        dest_path = os.path.join(output_folder, f"{base}_{counter}{ext}")
                        counter += 1

                shutil.move(img_path, dest_path)
                print(f"[+] Moved: {filename} -> {output_folder}/")
                moved_count += 1
            except Exception as e:
                print(f"[!] Error moving {img_path}: {e}")

    return moved_count

def process_similar_images():
    """Process similar images with threshold 0"""
    screenshot_dir = './my-screenshots/'
    similar_dir = os.path.join(screenshot_dir, 'similar')

    SIMILARITY_THRESHOLD = 0

    print(f"[+] Processing images for similarity (threshold: {SIMILARITY_THRESHOLD})...")

    similar_images = find_similar_images(screenshot_dir, SIMILARITY_THRESHOLD)

    if similar_images:
        print(f"[+] Found {len(similar_images)} groups of similar images")
        for original, group in similar_images.items():
            print(f"  {os.path.basename(original)} has {len(group)-1} similar image(s)")

        moved = move_duplicates(similar_images, similar_dir)
        print(f"[+] Moved {moved} similar images to {similar_dir}")
    else:
        print("[+] No similar images found")

def main():
    parser = argparse.ArgumentParser(description='Automated gowitness screenshot tool')
    parser.add_argument('input_file', help='Input file in IP,PORT format')
    args = parser.parse_args()

    print(f"[DEBUG] Python version: {sys.version}")
    print(f"[DEBUG] Working directory: {os.getcwd()}")

    if not os.path.exists(args.input_file):
        print(f"[!] Error: Input file '{args.input_file}' not found")
        sys.exit(1)

    create_urls_csv(args.input_file)
    check_and_install_go()
    install_gowitness()
    setup_python_env()
    run_gowitness()
    process_similar_images()

    print("[+] All tasks completed successfully!")

if __name__ == '__main__':
    main()
