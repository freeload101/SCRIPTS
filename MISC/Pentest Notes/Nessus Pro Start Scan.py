import requests
import urllib3
from datetime import datetime
from selenium import webdriver
from selenium.webdriver.common.by import By
from selenium.webdriver.support.ui import WebDriverWait
from selenium.webdriver.support import expected_conditions as EC
from selenium.webdriver.chrome.options import Options
from selenium.common.exceptions import TimeoutException, NoSuchElementException
import time
import traceback

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

NESSUS_URL = "https://localhost:8834"
USERNAME = "admin"
PASSWORD = "password"

class NessusWebAutomation:
    def __init__(self, url, username, password):
        self.url = url
        self.username = username
        self.password = password
        self.driver = None

    def setup_driver(self):
        """Initialize Chrome driver"""
        print("[DEBUG] Setting up Chrome driver...")
        chrome_options = Options()
        chrome_options.add_argument('--headless')
        chrome_options.add_argument('--no-sandbox')
        chrome_options.add_argument('--disable-dev-shm-usage')
        chrome_options.add_argument('--ignore-certificate-errors')
        chrome_options.add_argument('--disable-gpu')
        chrome_options.add_argument('--window-size=1920,1080')

        self.driver = webdriver.Chrome(options=chrome_options)
        print("[DEBUG] Chrome driver initialized")

    def login_web(self):
        """Login via web interface"""
        try:
            print(f"[DEBUG] Navigating to {self.url}/")
            self.driver.get(f"{self.url}/")
            time.sleep(3)

            username_field = WebDriverWait(self.driver, 10).until(
                EC.presence_of_element_located((By.CSS_SELECTOR, "input[type='text']"))
            )
            password_field = self.driver.find_element(By.CSS_SELECTOR, "input[type='password']")

            print(f"[DEBUG] Entering credentials")
            username_field.clear()
            username_field.send_keys(self.username)
            password_field.clear()
            password_field.send_keys(self.password)

            login_button = self.driver.find_element(By.CSS_SELECTOR, "button[type='submit']")
            login_button.click()

            time.sleep(5)
            print(f"[SUCCESS] Logged in - URL: {self.driver.current_url}")
            return True

        except Exception as e:
            print(f"[ERROR] Login failed: {e}")
            traceback.print_exc()
            return False

    def get_scans_via_api(self):
        """Get scans using API"""
        print("[DEBUG] Fetching scans via API...")
        session = requests.Session()
        session.verify = False

        try:
            response = session.post(
                f"{self.url}/session",
                json={"username": self.username, "password": self.password}
            )

            if response.status_code == 200:
                token = response.json()["token"]
                session.headers.update({"X-Cookie": f"token={token}"})

                scans_response = session.get(f"{self.url}/scans")
                if scans_response.status_code == 200:
                    scans = scans_response.json().get("scans", [])
                    print(f"[DEBUG] Retrieved {len(scans)} scans")
                    return scans
        except Exception as e:
            print(f"[ERROR] API request failed: {e}")

        return []

    def launch_scan_web(self, scan_name, scan_id):
        """Launch scan by clicking the glyphicons launch icon in td.scan-action-1"""
        try:
            print(f"[DEBUG] Launching scan: {scan_name} (ID: {scan_id})")

            self.driver.get(f"{self.url}/#/scans/folders/my-scans")
            time.sleep(5)

            print(f"[DEBUG] Current URL: {self.driver.current_url}")
            self.driver.save_screenshot('/tmp/nessus_scans_page.png')

            # Method 1: Direct CSS selector for td.scan-action-1 with data-id
            try:
                print(f"[DEBUG] Method 1: Looking for td.scan-action-1 > i[data-id='{scan_id}']")
                launch_icon = WebDriverWait(self.driver, 10).until(
                    EC.presence_of_element_located((By.CSS_SELECTOR, f"td.scan-action-1 > i.glyphicons.launch[data-id='{scan_id}']"))
                )

                print(f"[DEBUG] Found launch icon in td.scan-action-1")
                print(f"[DEBUG] Icon class: {launch_icon.get_attribute('class')}")
                print(f"[DEBUG] Icon data-id: {launch_icon.get_attribute('data-id')}")

                self.driver.execute_script("arguments[0].scrollIntoView(true);", launch_icon)
                time.sleep(1)

                try:
                    launch_icon.click()
                    print("[SUCCESS] Clicked launch icon (regular click)")
                except:
                    self.driver.execute_script("arguments[0].click();", launch_icon)
                    print("[SUCCESS] Clicked launch icon (JavaScript click)")

                time.sleep(3)
                self.driver.save_screenshot('/tmp/nessus_after_launch.png')
                return True

            except TimeoutException:
                print(f"[DEBUG] Method 1 failed - icon not found")

            # Method 2: Find all td.scan-action-1 cells and check data-id
            try:
                print("[DEBUG] Method 2: Finding all td.scan-action-1 cells")
                action_cells = self.driver.find_elements(By.CSS_SELECTOR, "td.scan-action-1")
                print(f"[DEBUG] Found {len(action_cells)} scan-action-1 cells")

                for idx, cell in enumerate(action_cells):
                    icons = cell.find_elements(By.CSS_SELECTOR, "i.glyphicons.launch")
                    for icon in icons:
                        icon_data_id = icon.get_attribute("data-id")
                        print(f"[DEBUG] Cell {idx}: data-id={icon_data_id}")

                        if icon_data_id == str(scan_id):
                            print(f"[DEBUG] Found matching icon in cell {idx}")

                            self.driver.execute_script("arguments[0].scrollIntoView(true);", icon)
                            time.sleep(1)

                            try:
                                icon.click()
                                print("[SUCCESS] Clicked launch icon (regular click)")
                            except:
                                self.driver.execute_script("arguments[0].click();", icon)
                                print("[SUCCESS] Clicked launch icon (JavaScript click)")

                            time.sleep(3)
                            self.driver.save_screenshot('/tmp/nessus_after_launch.png')
                            return True
            except Exception as e:
                print(f"[DEBUG] Method 2 failed: {e}")

            # Method 3: Find by scan name then locate launch icon in same row
            try:
                print("[DEBUG] Method 3: Finding by scan name in table")
                rows = self.driver.find_elements(By.TAG_NAME, "tr")

                for idx, row in enumerate(rows):
                    if scan_name in row.text:
                        print(f"[DEBUG] Found scan in row {idx}")

                        action_cell = row.find_elements(By.CSS_SELECTOR, "td.scan-action-1")
                        if action_cell:
                            launch_icons = action_cell[0].find_elements(By.CSS_SELECTOR, "i.glyphicons.launch")
                            if launch_icons:
                                icon = launch_icons[0]
                                print(f"[DEBUG] Found launch icon, data-id={icon.get_attribute('data-id')}")

                                self.driver.execute_script("arguments[0].scrollIntoView(true);", icon)
                                time.sleep(1)

                                try:
                                    icon.click()
                                    print("[SUCCESS] Clicked launch icon (regular click)")
                                except:
                                    self.driver.execute_script("arguments[0].click();", icon)
                                    print("[SUCCESS] Clicked launch icon (JavaScript click)")

                                time.sleep(3)
                                self.driver.save_screenshot('/tmp/nessus_after_launch.png')
                                return True
            except Exception as e:
                print(f"[DEBUG] Method 3 failed: {e}")

            print(f"[ERROR] All methods failed to launch scan")
            return False

        except Exception as e:
            print(f"[ERROR] Launch failed: {e}")
            traceback.print_exc()
            return False

    def cleanup(self):
        """Close browser"""
        print("[DEBUG] Cleaning up...")
        if self.driver:
            self.driver.quit()

def main():
    print("=" * 60)
    print("NESSUS SCAN AUTOMATION")
    print("=" * 60)

    automation = NessusWebAutomation(NESSUS_URL, USERNAME, PASSWORD)

    print("\n[STEP 1] Getting scan list via API...")
    all_scans = automation.get_scans_via_api()
    print(f"Found {len(all_scans)} total scans")

    running_scans = [s for s in all_scans if s.get("status") == "running"]

    if running_scans:
        print(f"\n[RESULT] Found {len(running_scans)} running scan(s). Not starting new scan.")
        for scan in running_scans:
            print(f"  - {scan['name']} (ID: {scan['id']})")
        return

    print("\n[STEP 2] Looking for scan to start...")

    target_scan = None
    oldest_date = float('inf')

    for scan in all_scans:
        last_mod = scan.get("last_modification_date", 0)

        if last_mod == 0:
            target_scan = scan
            break

        if last_mod < oldest_date:
            oldest_date = last_mod
            target_scan = scan

    if target_scan:
        scan_name = target_scan.get("name", "Unknown")
        scan_id = target_scan.get("id")
        last_mod = target_scan.get("last_modification_date", 0)

        if last_mod == 0:
            print(f"\n[RESULT] Found scan that has never been run: {scan_name} (ID: {scan_id})")
        else:
            last_mod_date = datetime.fromtimestamp(last_mod).strftime('%Y-%m-%d %H:%M:%S')
            print(f"\n[RESULT] Found oldest scan: {scan_name} (ID: {scan_id})")
            print(f"Last modified: {last_mod_date}")

        print(f"\n[STEP 3] Launching scan via web automation...")
        automation.setup_driver()

        if automation.login_web():
            automation.launch_scan_web(scan_name, scan_id)

        automation.cleanup()
    else:
        print("\n[RESULT] No scans found")

    print("\n" + "=" * 60)
    print("COMPLETE")
    print("=" * 60)

if __name__ == "__main__":
    main()
