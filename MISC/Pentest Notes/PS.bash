#!/bin/bash
# Network Packet Loss & System Monitor
# Displays 30-second delta changes in network statistics

INTERVAL=10

while :; do
  printf "\033[H\033[J"
  echo "╔════════════════════════════════════════════════════════════════════════════╗"
  echo "║  Network Packet Loss Monitor - $(date '+%Y-%m-%d %H:%M:%S')                      ║"
  echo "║  Showing changes over last ${INTERVAL} seconds (cumulative counters since boot)  ║"
  echo "╚════════════════════════════════════════════════════════════════════════════╝"
  echo ""

  # 1) Interface-level errors/drops (NIC hardware layer)
  echo "┌─ INTERFACE ERRORS/DROPS (last ${INTERVAL}s) ─────────────────────────────────────┐"
  iface_output=$(awk '
  NR==FNR{for(i=3;i<=NF;i++)b[NR,i]=$i;next}
  {iface=$1; $1="";
   for(i=3;i<=NF;i++){d=$i-b[NR,i]; if(d)printf "%-10s col%-2d %+8d\n",iface,i,d}
  }' /proc/net/dev <(cat /proc/net/dev) |
  grep -E 'errs|drop' | sort -k1,2)

  if [[ -z "$iface_output" ]]; then
    echo "  ✓ No interface errors or drops detected"
  else
    echo "$iface_output" | awk '{printf "  %-12s %-8s %s packets\n", $1, $2, $3}'
  fi
  echo "└────────────────────────────────────────────────────────────────────────────┘"
  echo ""

  # 2) CPU softnet drops (kernel network stack processing layer)
  echo "┌─ CPU SOFTIRQ PACKET DROPS (last ${INTERVAL}s) ────────────────────────────────────┐"
  echo "  Backlog Queue Overflows (netdev_max_backlog exceeded):"
  softnet_drops=$(awk '
  NR==FNR{for(i=1;i<=NF;i++)b[NR,i]=$i;next}
  {cpu=NR-1; for(i=1;i<=NF;i++){d=$i-b[NR,i]; if(d && i==2)printf "    CPU%-2d: %+8d packets dropped\n",cpu,d}}
  ' /proc/net/softnet_stat <(cat /proc/net/softnet_stat))

  if [[ -z "$softnet_drops" ]]; then
    echo "    ✓ No CPU backlog drops detected"
  else
    echo "$softnet_drops"
  fi
  echo ""

  echo "  Time Squeeze Events (budget exhausted before queue empty):"
  time_squeeze=$(awk '
  NR==FNR{for(i=1;i<=NF;i++)b[NR,i]=$i;next}
  {cpu=NR-1; for(i=1;i<=NF;i++){d=$i-b[NR,i]; if(d && i==3)printf "    CPU%-2d: %+8d events\n",cpu,d}}
  ' /proc/net/softnet_stat <(cat /proc/net/softnet_stat))

  if [[ -z "$time_squeeze" ]]; then
    echo "    ✓ No time squeeze events"
  else
    echo "$time_squeeze"
  fi
  echo "└────────────────────────────────────────────────────────────────────────────┘"
  echo ""

  # 3) Conntrack table usage (current state, not delta)
  if [[ -e /proc/sys/net/netfilter/nf_conntrack_count ]]; then
    echo "┌─ CONNECTION TRACKING (current state) ──────────────────────────────────────┐"
    ct_count=$(cat /proc/sys/net/netfilter/nf_conntrack_count)
    ct_max=$(cat /proc/sys/net/netfilter/nf_conntrack_max)
    ct_pct=$(awk '{printf "%.0f",100*$1/$2}' /proc/sys/net/netfilter/nf_conntrack_{count,max})
    printf "  Connections: %'d / %'d (%d%% capacity)\n" $ct_count $ct_max $ct_pct
    echo "└────────────────────────────────────────────────────────────────────────────┘"
    echo ""
  fi

  # 4) Top memory consumers (filtered by uptime)
  echo "┌─ TOP CONSUMERS (active processes only) ─────────────────────────────┐"
  VarUptime=`uptime | sed -re 's/.*up (.*) days.*/\1/g'`
  VarUptimeNeg1=`echo $VarUptime - 1 |bc`
  ps -eo etime,pid,user,%mem,%cpu,cmd --sort -%mem |grep -iaEv "(^$VarUptime|^$VarUptimeNeg1|xfcd|sshd|pipewire|systemd)"  | head -n 30
  echo "└────────────────────────────────────────────────────────────────────────────┘"
  echo ""
  echo "Next refresh in ${INTERVAL} seconds... (Ctrl+C to exit)"

  sleep $INTERVAL
done
