UUID,APP,Input Correlation Fields,TITLE,TYPE,Sanitized (public) Query
,,,Determine if a process is orphaned,,aid=<aid> <process_id> event_simpleName=ProcessRollup2 | eval JoinId=ParentProcessId_decimal | rename CommandLine as ChildCommandLine | join type=outer JoinId [search aid=<aid> event_simpleName=ProcessRollup2 | eval JoinId=TargetProcessId_decimal | rename CommandLine as ParentCommandLine] | eval ParentCommandLine=coalesce(ParentCommandLine,"IamAnOrphan")
,,,Find orphaned processes for a host v1 (filtering on common hashes),,event_platform=Mac aid=<aid> event_simpleName=ProcessRollup2 NOT CommandLine="/System/*" NOT CommandLine="/Library/*" NOT CommandLine="/usr/libexec/*" NOT CommandLine=xpcproxy* NOT CommandLine="/Applications/Utilities/*" NOT CommandLine="make*" NOT CommandLine=ipconfig* NOT CommandLine="/Applications/*" NOT "/Users/*/Library/Application Support/*" NOT CommandLine=<bunch_of_internal_stuff> | eval JoinId=ParentProcessId_decimal | rename CommandLine as ChildCommandLine | join type=outer aid,TargetProcessId_decimal   [search event_platform=Mac aid=<aid> event_simpleName=EndOfProcess  | rename _time as EndTime | fields aid,TargetProcessId_decimal, EndTime] | eval duration=if(isnull(EndTime),now()-_time,EndTime-_time) | join type=outer JoinId,aid  [search event_platform=Mac aid=<aid> event_simpleName=ProcessRollup2 | eval JoinId=TargetProcessId_decimal  | rename CommandLine as ParentCommandLine | fields JoinId, ParentCommandLine] |  eval ParentCommandLine=coalesce(ParentCommandLine,"IamAnOrphan") | search ParentCommandLine="IamAnOrphan" | eval ChildCommandLine=substr(ChildCommandLine,1,50) | stats values(ChildCommandLine) as Commands, max(duration) as duration, dc(aid) as AgentsWithHash by SHA256HashData| search AgentsWithHash=1| join type=outer SHA256HashData [search event_platform=Mac event_simpleName=VT  | stats sum(detectionCount) as VTCount by sha256 | rename sha256 as SHA256HashData] | join type=outer SHA256HashData  [search event_platform=Mac event_simpleName=ProcessRollup2 | top SHA256HashData limit=10000 by aid | stats dc(aid) as CommonGPopCount by SHA256HashData] | join type=outer SHA256HashData [search event_platform=Mac event_simpleName=ProcessRollup2 | rare SHA256HashData limit=10000 by aid  | stats dc(aid) as RareGPopCount by SHA256HashData] | fillnull value=0 CommonGPopCount | fillnull value=0 RareGPopCount| fillnull value=0 VTCount | search CommonGPopCount<2 RareGPopCount<2
,,,Find orphaned processes for a host v2 (filtering based on common hashes and duration of process),,event_platform=Mac aid=<aid> event_simpleName=ProcessRollup2 NOT CommandLine="/System/*" NOT CommandLine="/Library/*" NOT CommandLine="/usr/libexec/*" NOT CommandLine=xpcproxy* NOT CommandLine="/Applications/Utilities/*" NOT CommandLine="make*" NOT CommandLine=ipconfig* NOT CommandLine="/Applications/*" NOT "/Users/*/Library/Application Support/*" NOT CommandLine=<bunch_of_internal_stuff> |  eval JoinId=ParentProcessId_decimal |  rename CommandLine as ChildCommandLine | join type=outer aid,TargetProcessId_decimal [search event_platform=Mac aid=<aid> event_simpleName=EndOfProcess | rename _time as EndTime | fields aid,TargetProcessId_decimal, EndTime] | eval duration=if(isnull(EndTime),now()-_time,EndTime-_time) | join type=outer JoinId,aid [search event_platform=Mac aid=<aid> event_simpleName=ProcessRollup2 |  eval JoinId=TargetProcessId_decimal |  rename CommandLine as ParentCommandLine | fields JoinId, ParentCommandLine] |  eval ParentCommandLine=coalesce(ParentCommandLine,"IamAnOrphan") | search ParentCommandLine="IamAnOrphan" | eval ChildCommandLine=substr(ChildCommandLine,1,50) | stats values(ChildCommandLine) as Commands, max(duration) as duration, dc(aid) as AgentsWithHash by SHA256HashData | search AgentsWithHash=1 | join type=outer SHA256HashData [search event_platform=Mac event_simpleName=VT | stats sum(detectionCount) as VTCount by sha256 | rename sha256 as SHA256HashData] | join type=outer SHA256HashData [search event_platform=Mac event_simpleName=ProcessRollup2 | top SHA256HashData limit=10000 by aid | stats dc(aid) as CommonGPopCount by SHA256HashData] | join type=outer SHA256HashData [search event_platform=Mac event_simpleName=ProcessRollup2 | rare SHA256HashData limit=10000 by aid | stats dc(aid) as RareGPopCount by SHA256HashData] | fillnull value=0 CommonGPopCount | fillnull value=0 RareGPopCount| fillnull value=0 VTCount | search CommonGPopCount<2 RareGPopCount<2 (duration>10 OR VTCount>0)
,,,Processes typically associated with Word,,event_platform=Mac event_simpleName=*ProcessRollup2 [search event_simpleName=*ProcessRollup2 event_platform=Mac CommandLine="/Applications/*Microsoft Word*" |  fields ProcessGroupId_decimal ] |  stats values(CommandLine) as Commands, count by aid,ProcessGroupId_decimal | search Commands="/Applications/*Microsoft Word*"
,,,Find out what processes Word launched that arenâ€™t Word,,aid=<aid> event_simpleName=*ProcessRollup2 NOT CommandLine="/Applications/*Microsoft Word*"  [search aid=<aid> CommandLine="/Applications/*Microsoft Word*" event_simpleName=*ProcessRollup2 |  rename TargetProcessId_decimal as ProcessGroupId_decimal | return 10000 ProcessGroupId_decimal]
,,,Count processes launched by Word,,aid=<aid> event_simpleName=*ProcessRollup2 NOT CommandLine="/Applications/*Microsoft Word*"  [search aid=<aid> CommandLine="/Applications/*Microsoft Word*" event_simpleName=*ProcessRollup2 |  rename TargetProcessId_decimal as ProcessGroupId_decimal | return 10000 ProcessGroupId_decimal]
,,,Removing the quarantine attribute on a file,,event_platform=Mac event_simpleName=ProcessRollup2 CommandLine="*xattr -d -r com.apple.quarantine*" NOT <redacted> NOT <redacted>
,,,Busy process trees,,event_platform=Mac event_simpleName=ProcessRollup2 | stats count by ProcessGroupId_decimal,aid |  search count>50 | map search="search aid=$aid$ ProcessGroupId_decimal=$ProcessGroupId_decimal$ TargetProcessId_decimal=$ProcessGroupId_decimal$" | search NOT CommandLine=<redacted> NOT CommandLine=<redacted>
,,,Processes running from tmp dirs,,event_platform=Mac event_simpleName=ProcessRollup2 (CommandLine="/tmp/*" OR CommandLine="/private/tmp/*") NOT <redacted> NOT <redacted> NOT <redacted>
,,,Processes running from /Library/Scripts,,event_platform=Mac CommandLine="/Library/Scripts/*"
,,,Copy from tmp directories to user directories,,event_platform=Mac event_simpleName=ProcessRollup2 FileName=cp CommandLine="*tmp*Users*"
,,,Long-running process with few network connections - no filtering,,event_platform=Mac event_simpleName=ProcessRollup2 aid=<aid> | join type=outer ContextProcessId_decimal [search event_platform=Mac aid=<aid> event_simpleName=EndOfProcess | rename _time as EndTime | fields aid,ContextProcessId_decimal, EndTime] | eval duration=if(isnull(EndTime),now()-_time,EndTime-_time) | join type=outer aid,ProcessGroupId_decimal [search event_platform=Mac event_simpleName=NetworkConnect* aid=<aid> |  stats count as NetworkConnectionCount by aid, ContextProcessId_decimal |  rename ContextProcessId_decimal as ProcessGroupId_decimal] | search duration>86399 NetworkConnectionCount<5
,,,Long-running process with few network connections - with filtering,,event_platform=Mac event_simpleName=ProcessRollup2 aid=<aid> NOT [search event_platform=Mac event_simpleName=ProcessRollup2 (CommandLine=<yourC2> OR ...) aid=<aid> | fields ProcessGroupId_decimal] | join type=outer TargetProcessId_decimal [search event_platform=Mac aid=<aid> event_simpleName=EndOfProcess | rename _time as EndTime | fields aid,TargetProcessId_decimal, EndTime] | eval duration=if(isnull(EndTime),now()-_time,EndTime-_time) | join type=outer aid,ProcessGroupId_decimal [search event_platform=Mac event_simpleName=NetworkConnect* aid=<aid> |  stats count as NetworkConnectionCount by aid, ContextProcessId_decimal |  rename ContextProcessId_decimal as ProcessGroupId_decimal] | search duration>86399 NetworkConnectionCount<5
,,,Process tree contains both sh and launchctl,,event_platform=Mac aid=<aid> event_simpleName=*ProcessRollup2 (sh OR launchctl) |  transaction aid,ProcessGroupId_decimal | search sh launchctl NOT <redacted>
,,,Process tree contains lots of shells like bash or sh,,event_platform=Mac event_simpleName=*ProcessRollup2 (CommandLine=sh* OR CommandLine=/bin/sh* OR CommandLine=/bin/bash) aid=<aid> |  stats values(CommandLine) as Commands,count by aid,ProcessGroupId_decimal |  search NOT <yourC2>|  search count>20
,,,Chown commands run on hidden dirs in user directories,,event_simpleName=*ProcessRollup2 event_platform=Mac chown NOT <redacted> NOT CommandLine=<redacted> | regex CommandLine="/Users/[a-z]+/\..*"
,,,Chmod commands run on hidden dirs in user directories,,event_simpleName=*ProcessRollup2 event_platform=Mac chmod NOT <redacted> |  regex CommandLine="/Users/[a-z]+/\..*" |  table CommandLine
,,,Lots of profiling commands in the process tree,,event_platform=Mac event_simpleName=ProcessRollup2 aid=<aid> (networksetup OR who OR whoami OR sysctl) |  eval JoinId=ParentProcessId_decimal |  rename CommandLine as ChildCommandLine|  join type=outer aid,JoinId [search event_platform=Mac aid=0000de4aa30a4a616d0bb3bf5986eadc event_simpleName=ProcessRollup2 |  eval JoinId=TargetProcessId_decimal |  rename CommandLine as ParentCommandLine] | search NOT ChildCommandLine=<redacted> | search NOT ParentCommandLine=<redacted> | stats values(ChildCommandLine) as Commands, count by aid | search count>1
,,,Rare hashes using security_authtrampoline unfiltered (so you can play with thresholds),,event_platform=Mac event_simpleName=*ProcessRollup2 [search event_platform=Mac event_simpleName=*ProcessRollup2 security_authtrampoline | fields ProcessGroupId_decimal] | dedup aid, SHA256HashData | eval CommandLine=substr(CommandLine,1,100)| stats values(CommandLine) as Commands, dc(aid) as AuthtrampolineCount by SHA256HashData | eventstats sum(AuthtrampolineCount) as AuthtrampolineTotal| eval AuthTrampolinePerc=round((AuthtrampolineCount/AuthtrampolineTotal)*100,7)| join type=outer SHA256HashData [search event_platform=Mac event_simpleName=*ProcessRollup2 | rare SHA256HashData limit=10000 by aid | stats dc(aid) as RareGPopCount by SHA256HashData | eventstats sum(RareGPopCount) as RareGPopTotal | eval RareGPopPerc=round((RareGPopCount/RareGPopTotal)*100,7) ] |  join type=outer SHA256HashData [search event_platform=Mac event_simpleName=*ProcessRollup2 | top SHA256HashData limit=10000 by aid | stats dc(aid) as CommonGPopCount by SHA256HashData | eventstats sum(CommonGPopCount) as CommonGPopTotal | eval CommonGPopPerc=round((CommonGPopCount/CommonGPopTotal)*100,7)]| fillnull value=0 CommonGPopCount | fillnull value=0 RareGPopCount
,,,Rare hashes using security_authtrampoline,,event_platform=Mac event_simpleName=*ProcessRollup2 [search event_platform=Mac event_simpleName=*ProcessRollup2 security_authtrampoline | fields ProcessGroupId_decimal] | dedup aid, SHA256HashData | eval CommandLine=substr(CommandLine,1,100) | stats values(CommandLine) as Commands, dc(aid) as AuthtrampolineCount by SHA256HashData | search AuthtrampolineCount=1 | join type=outer SHA256HashData [search event_platform=Mac event_simpleName=*ProcessRollup2 | rare SHA256HashData limit=10000 by aid | stats dc(aid) as RareGPopCount by SHA256HashData] |  join type=outer SHA256HashData [search event_platform=Mac event_simpleName=*ProcessRollup2 | top SHA256HashData limit=10000 by aid | stats dc(aid) as CommonGPopCount by SHA256HashData] | fillnull value=0 CommonGPopCount | fillnull value=0 RareGPopCount | search CommonGPopCount<2 RareGPopCount<2 | eval Auth_Common_Rare=AuthtrampolineCount.",".CommonGPopCount.",".RareGPopCount | fields SHA256HashData, Commands, Auth_Common_Rare
,,,Self-deleting rare processes,,event_platform=Mac event_simpleName=ProcessSelfDeleted | map search="search event_simpleName=*ProcessRollup2 aid=$aid$ TargetProcessId_decimal=$ContextProcessId_decimal$" | dedup aid,SHA256HashData | eval CommandLine=substr(CommandLine,1,50) | stats values(CommandLine) as Commands, dc(aid) as UniqueAgentCount by SHA256HashData | join type=outer SHA256HashData [search event_platform=Mac event_simpleName=*ProcessRollup2 | top SHA256HashData limit=10000 by aid | stats dc(aid) as CommonGPopCount by SHA256HashData] | join type=outer SHA256HashData [search event_platform=Mac event_simpleName=*ProcessRollup2 | rare SHA256HashData limit=10000 by aid | stats dc(aid) as RareGPopCount by SHA256HashData] | fillnull value=0 CommonGPopCount | fillnull value=0 RareGPopCount | search UniqueAgentCount=1 CommonGPopCount<2 RareGPopCount<2
,,,Rare launch agents,,event_platform=Mac event_simpleName=*ProcessRollup2 CommandLine=*LaunchAgents* | dedup aid,CommandLine | makemv CommandLine delim=" " |  eval CommandLine=mvfilter(match(CommandLine, ".*LaunchAgents.*")) |  eval CommandLine=replace(CommandLine,"/Users/[a-z]+/", "/") |  eval CommandLine=replace(CommandLine,"\"$", "") | dedup aid,CommandLine |  stats count by CommandLine |  sort count 
,,,Count network connection counts for a process,,event_platform=Mac event_simpleName=*ProcessRollup2 <ProcessGroupId_decimal> aid=<aid> | join aid,ProcessGroupId_decimal [search event_platform=Mac <ProcessGroupId_decimal> aid=<aid> event_simpleName=NetworkConnect* |  stats count as NetworkConnectionCount by aid, ContextProcessId_decimal |  rename ContextProcessId_decimal as ProcessGroupId_decimal] | stats count by aid,ProcessGroupId_decimal

